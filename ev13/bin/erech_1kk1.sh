#!/bin/bash
set -u

# USAGE: FIRST adapt the sed-line here and copy the xml-Vorlage to your current-working-dir, and then call this with the NAME of your new xml file, shich will be generated by the sed-line here:
# on-time generated xml-vorlage: - either https://tools.pdf24.org/de/elektronische-rechnung-erstellen (XRech/ZugFerdxml/pdf/...) - /OR (done) XRech-xml:  https://xrechnung-erstellen.com - then offline anpassen for 1kk
xmlVorlage_FN='RechVorlage1_1kk.xml'
fp1=${1:?"usage1: <my-FP>  <new-xml-file to be generated here by sed-replacements of the ${xmlVorlage_FN} >"}
out1="${fp1}.noxml.pdf"
out2="${fp1}.pdf"
export mustangJarFP='/up1/optu/ERech1/Mustangs/Mustang-CLI-2.16.3.jar'

##------- sed : generate new xml:
#-nts: once in quarter also adapt the Vertrag-ID  manually!
# e.g: sed  -e 's@__1stdzahl__@168@g'   -e 's@__1stddatumbis__@20250901@g'    -e 's@__1stddatumvom__@20250801@g'   -e 's@__1rechdatum__@20250904@g'    -e 's@__1rechnr__@2025-08-DoPro@g'  -e 's@__1netto__@11424@g'    -e 's@__1ust__@2170.56@g' -e 's@__1brutto__@13594.56@g'  ${xmlVorlage_FN}   >|   "$fp1"
sed  -e 's@__1stdzahl__@88@g'   -e 's@__1stddatumbis__@20251001@g'    -e 's@__1stddatumvom__@20250901@g'   -e 's@__1rechdatum__@20251006@g'    -e 's@__1rechnr__@2025-09-DoPro@g'  -e 's@__1netto__@5984@g'    -e 's@__1ust__@1136.96@g' -e 's@__1brutto__@7120.96@g'  "${xmlVorlage_FN}"  >|   "$fp1"

##------ ERech-gen based on above sed-generated xml:
echo; echo  "--- generating zugferd-PDF based on input-xml-xrech-file   $fp1 :"   # (still NOT containg its xml file! so can NOT yet be validated!)
java -Xmx1G -Dfile.encoding=UTF-8 -jar  "${mustangJarFP}"  --no-notices --action pdf  --source  "$fp1"  --out $out1

echo; echo  "--- add/integrate the input-xml-file into generated -zugferd-PDF :"
java -Xmx1G -Dfile.encoding=UTF-8 -jar "${mustangJarFP}"   --no-notices --action combine  --source  $out1  --source-xml  "$fp1"  --out $out2  --format zf  --version 2 --profile X --no-additional-attachments
echo  "- now can be validated, or in Quba view incl. xml!"

echo; echo  "--- validate the generated zugferd-PDF which contains its xml-file:"
java -Xmx1G -Dfile.encoding=UTF-8 -jar "${mustangJarFP}"   --no-notices --action validate  --source  $out2

echo; echo "-- now can validate with Quba:  /up1/optu/ERech1/Quba/Quba-*.AppImage"  # -did NOT work with cmdline-arg! so ziehe pdf-file mit mouse da rein!

